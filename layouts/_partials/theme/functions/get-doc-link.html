<!--
  ~ Copyright 2026, TeamDev. All rights reserved.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Redistribution and use in source and/or binary forms, with or without
  ~ modification, must retain the above copyright notice and the following
  ~ disclaimer.
  ~
  ~ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ~ "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ~ LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ~ A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ~ OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ~ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ~ LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ~ DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ~ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ~ (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ~ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  -->

<!--
  Returns a documentation link adjusted to the current documentation version.

  If the user is viewing the main (unversioned) documentation, the link is returned as-is.
  If the user is viewing a specific version, the version prefix is automatically added.

  For example, the link `docs/guides/requirements/` will be returned as:
  - `docs/guides/requirements/` for the main documentation;
  - `docs/1/guides/requirements/` for the documentation version 1.
  - `docs/2/guides/requirements/` for the documentation version 2.

  The versioning logic is handled independently for each module from the `data/versions.yml`.
  Each module maintains its own versioned paths, such as:
  - `docs/1`, `docs/2`
  - `docs/validation/1`, `docs/validation/2`
  - `docs/framework/1`, `docs/framework/2`

  The link in the markdown file should be provided in the following format:
  ```
  [Start new project](docs/guides/start-new-project/)
  [Validation overview](docs/validation/00-intro/)
  ```

  If the link already contains a version in the path, it will not be processed.
-->

{{ $link := .link }}
{{ $pageContext := .page }}

{{ $modules := slice }}
{{ $versions := site.Data.versions | default (slice) }}
{{ range $module, $items := $versions }}
    {{ $modules = $modules | append $module }}
{{ end }}

{{ $currentVersionData := partial "theme/functions/get-doc-version-data.html" $pageContext }}
{{ $currentVersion := $currentVersionData.version }}
{{ $currentModule := $currentVersionData.module }}

{{ $moduleBase := cond (eq $currentModule "docs") "docs" (printf "docs/%s" $currentModule) }}
{{ $modulePattern := printf `^/?%s/` $moduleBase }}
{{ $versionedPattern := printf `^/?%s/[0-9]+([.-][0-9]+)*(/|$)` $moduleBase }}

{{ $isModule := findRE $modulePattern $link }}
{{ $isVersioned := findRE $versionedPattern $link }}

{{ $isOtherModule := false }}
{{ if eq $currentModule "docs" }}
  {{ $otherModulesPattern := printf `^/?%s/(%s)(/|$)` $moduleBase (delimit $modules "|") }}
  {{ $isOtherModule = findRE $otherModulesPattern $link }}
{{ end }}

{{ if and $isModule (not $isVersioned) (not $isOtherModule) }}
  {{ $link = replaceRE $moduleBase $currentVersion.url $link }}
{{ end }}

{{ $link = $link | relURL }}
{{ return $link }}
